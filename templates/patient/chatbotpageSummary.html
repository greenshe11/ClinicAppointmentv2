<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
     <title>ChatClinic</title>
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/bootstrap/css/bootstrap.min.css')}}">
     <script src="{{ url_for('static',filename='assets/bootstrap/js/bootstrap.min.js')}}"></script>
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/css/chatbotpage.css')}}">
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
     
     <!-- Favicons-->
     <link rel="icon" href="{{ url_for('static',filename='assets/img/favicon.png')}}">
     <link rel="icon" href="{{ url_for('static',filename='assets/img/apple-touch-icon.png')}}">

     <!-- Fonts -->
     <link href="https://fonts.googleapis.com" rel="preconnect">
     <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">

     <!--Veondor CSS Files-->
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/vendor/bootstrap/css/bootstrap.min.css')}}">
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/vendor/bootstrap-icons/bootstrap-icons.css')}}">
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/vendor/aos/aos.css')}}">
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/vendor/fontawesome-free/css/all.min.css')}}">
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/vendor/glightbox/css/glightbox.min.css')}}">
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/vendor/swiper/swiper-bundle.min.css')}}">




     <!-- Main CSS File -->
     <link rel="stylesheet" href="{{ url_for('static',filename='assets/css/main.css')}}">
</head>
<body>
     <header id="header" class="header sticky-top">


          <!-- Navigations -->
          <div class="branding d-flex align-items-center">
               <div class="container position-relative d-flex align-items-center justify-content-between">
                    <a href="/" class="logo d-flex align-items-center me-auto">
                         <h1 class="sitename">ISAT-U ClinicHub</h1>
                    </a>

                    <!--Navigation Menu-->
                    <nav id="navmenu" class="navmenu">
                         <ul>
                              <li><a href="/" class="">Home</a></li>
                              <li><a href="/schedule" class="">Schedules</a></li>
                              <li><a href="/profile" class="">Account</a></li>
                              <li><a href="#" class="active">Make an Appointment</a></li>
                         </ul>
                         <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
                    </nav>

                  
               </div>

          </div>
     </header>
     <!--DONT DELETE: THIS AREA IS WHERE THE SIDE BAR WILL BE INSERTED-->
   
     <div id="main-body">
          <div id="header">
               <ul class="nav nav-pills">
                    <li class="nav-item mx-2">
                         <a class="nav-link" aria-current="page" href="/"><</a>
                    </li>
                    <li class="nav-item mx-2">
                         <a class="nav-link white" href="/chatbotpage">Symptoms</a>
                    </li>
                    <li class="nav-item mx-2">
                         <a class="nav-link white" href="/chatbotpage/response">Response</a>
                    </li>
                    <li class="nav-item mx-2">
                         <a class="nav-link white" href="/chatbotpage/response/appointment">Appointment</a>
                    </li>
                    <li class="nav-item mx-2">
                         <a class="nav-link active tab" style="background-color: green; border-radius: 0px;" href="chatbotpage/response/appointment/summary">Summary</a>
                    </li>
               </ul>
          </div>
          
          <div class="cbp-dialog-container">
               
               <div class="cbp-dialog" style=" height: 100%; flex-direction: column;">
                    <p><b>Appointment Datetime: </b><span id="sum-datetime"></span>
                    </p>
                    <p><b>Name: </b><span id="sum-name"></span>
                    </p>
                    <p><b>Email: </b><span id="sum-email"></span>
                    </p>
                    <p><b>Contact No: </b><span id="sum-contact"></span>
                    </p>
                    <p><b>Symptoms: </b><span id="sum-symptoms"></span>
                    </p>
                    <p><b>Initial Diagnosis: </b><span id="sum-response"></span>
                    </p>
                    <p><b>Additional Complaints: </b><span id="sum-complaints"></span>
                    <hr>
                    <p><i><u>Check your info above</u> and press <b>Send Request</b> below. Once request is received by the staff, a confirmation SMS will be sent to your number. <br> You can navigate to <b>Menu  â†’ Schedules</b> to see the status of all your appointments.
                    </i>
                    </p>
                    
               </div>
          </div>
     </div>    
     <div id="text-area"  >
          <button id="cbp-send-request" style="width: 100%; border-style: solid; border-color: white; color: white; border-width: 2px; background-color: green">Send Request</button>
     </div>
     <!-- Vendor JS Files -->
     <script src="{{ url_for('static',filename='assets/vendor/bootstrap/js/bootstrap.bundle.min.js')}}"></script>
     <script src="{{ url_for('static',filename='assets/vendor/php-email-form/validate.js')}}"></script>
     <script src="{{ url_for('static',filename='assets/vendor/aos/aos.js')}}"></script>
     <script src="{{ url_for('static',filename='assets/vendor/glightbox/js/glightbox.min.js')}}"></script>
     <script src="{{ url_for('static',filename='assets/vendor/purecounter/purecounter_vanilla.js')}}"></script>
     <script src="{{ url_for('static',filename='assets/vendor/swiper/swiper-bundle.min.js')}}"></script>


     <!-- Main JS File -->
     <script src="{{ url_for('static',filename='assets/js/main.js')}}"></script>
     <!--DONT DELETE-->
     <script type="module">
          import {sidebar, getUserData} from "/static/components/sidebar/script.js";
          import {getSession, getTimeName, createAppointment, getAppointments} from "/static/components/calendarSelection/script.js";
          import { createRecommendationSent , getCodesFromSymptomsArray} from "/static/pageScripts/utils.js"    
          sidebar(document.getElementById('home-sidebar-insert-area'))

          /**
     * Creates a new symptom entry in the database associated with a given appointment.
     * 
     * @async
     * @function createSymptoms   
     * @param {number} Appointment_ID - The ID of the appointment.
     * @param {string} Symptoms_Code - The code of the symptom to be created in the database.
     * @returns {Promise<Object>} - A promise that resolves to the response of the symptom creation operation.
     */
     const createSymptoms = async (Appointment_ID, Symptoms_Code) => {
          console.log(Symptoms_Code)
          const response = await fetch('/api/symptoms', {
          method: 'POST',
          headers: {
          'Content-Type': 'application/json',
          },
          body: JSON.stringify({ Appointment_ID: Appointment_ID, Symptoms_Code: Symptoms_Code }),
          });
          const resJson = await response.json()
          console.log("createSymptoms()", resJson)
          return resJson
     }
     
     
     /**
     * Renders appointment data, user data, and symptoms data into the HTML elements on the page.
     * 
     * @async
     * @function renderData
     * @returns {void}
     */
     const renderData = async () => {
          // Fetch session and user data
          const sessionData = await getSession()
          const userData = await getUserData().then((data)=>{return data[0]}) // Get only the first result
          
          // Extract session data
          const day = sessionData.appointment_day
          const monthName = sessionData.appointment_monthName
          const month = sessionData.appointment_month
          const year = sessionData.appointment_year
          const timeName = sessionData.appointment_timeName
          const time = sessionData.appointment_time
          const symptoms = sessionData.symptoms_selected
          const symptomsString = symptoms.join(', ') // Join symptoms into a comma-separated string
          const response = createRecommendationSent(sessionData.symptoms_selected) // Generate response for symptoms
          const userId = sessionData.userId
          const codes = getCodesFromSymptomsArray(symptoms) // Get symptom codes
          const complaints = sessionData.complaints
          console.log('complaints', complaints)
     
          // Render data to HTML elements
          document.getElementById('sum-datetime').innerHTML = `${monthName} ${day}, ${year}`
          document.getElementById('sum-name').innerHTML = `${userData.PatientLastName}, ${userData.PatientName}`
          document.getElementById('sum-email').innerHTML = `${userData.PatientEmail}`
          document.getElementById('sum-contact').innerHTML = `${userData.PatientContactNo}`
          document.getElementById('sum-symptoms').innerHTML = `${symptomsString}`
          document.getElementById('sum-response').innerHTML = `${response}`
          document.getElementById('sum-complaints').innerHTML = complaints
          
          // Function to navigate to home after checking appointment availability and creating a new appointment
          const toHome = async () => {
          const value = await getAppointments(month, year, day) // Check for existing appointments
          for (let i = 0; i < value.length; i++) {
               if (value[i].Appointment_Time == time) { // If there's an appointment at the same time
                    alert("Selected date is not available / is taken.")
                    window.location.href = '/chatbotpage/response/appointment' // Redirect to appointment page
                    return null
               }
          }
     
          const newAppointment = await createAppointment(userId, day, month, time, year, 0, complaints) // Create a new appointment
          for (let i = 0; i < codes.length; i++) {
               let newSymptoms = await createSymptoms(newAppointment.id, codes[i]) // Create symptoms for the appointment
               console.log(i, newAppointment.id, newSymptoms)
          }
     
          window.location.href = '/schedule' // Redirect to success page
          }
     
          // Add click event to send button
          const sendButton = document.getElementById('cbp-send-request')
          sendButton.onclick = toHome
     }
     
     // Call renderData function to render the data on page load
     renderData()

     </script>
</body>

</html>